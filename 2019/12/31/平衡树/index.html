<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"wbwblog.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":true,"nav":{"utterances":{"order":-1}},"activeClass":"utterances"},"stickytabs":true,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js" defer></script>



<link rel="canonical" href="https://wbwblog.github.io/2019/12/31/%E5%B9%B3%E8%A1%A1%E6%A0%91/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://wbwblog.github.io/2019/12/31/%E5%B9%B3%E8%A1%A1%E6%A0%91/","path":"2019/12/31/平衡树/","title":"平衡树"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>平衡树 | wbw121124's blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script><script src="/js/pjax.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.3.1/pdfobject.min.js","integrity":"sha256-jI72I8ZLVflVOisZIOaLvRew3tyvzeu6aZXFm7P7dEo="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js" defer></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js" defer></script>


  <script src="/js/third-party/pace.js" defer></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{"copy_tex_js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js","integrity":"sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="}}</script>
  <script src="/js/third-party/math/katex.js" defer></script>


<script class="next-config" data-name="subtitle_typing" type="application/json">{"enable":true,"typing_speed":50,"deleting_speed":10,"pause_before_delete":1000,"pause_before_type":50,"subtitles":["Welcome to my blog","Enjoy your stay","Have a great day!","Where there is a will, there is a way.","Hope for the best, plan for the worst.","Wisdom is more precious than wealth.","Action speaks louder than words.","Time and tide wait for no man.","Experience is the best teacher.","All that glitters is not gold.","Failure is the mother of success.","A journey of a thousand miles begins with a single step.","The early bird catches the worm.","Nothing is impossible to a willing heart.","Don't put off till tomorrow what you can do today.","Every cloud has a silver lining.","Haste makes waste.","Better late than never.","Honesty is the best policy.","Live and learn.","Health is wealth.","First impressions are the most lasting.","One man's meat is another man's poison.","A friend in need is a friend indeed.","Life is not all roses.","Think twice before you act.","Pride goes before a fall.","Two heads are better than one.","Well begun is half done.","To be, or not to be, that is the question.","Action speak louder than words.","An idle youth,a needy age.","All is well that ends well.","Misfortune is a good teacher.","Faith can move mountains.","He that promises too much means nothing.","He would climb the ladder must begin at the bottom.","If you are not inside a house, you don not know about its leaking.","It is never too late to mend.","Yesterday will not be called again.","Men will die for wealth, as bird for food.","Success belongs to the persevering.","The man who has made up his mind to win will never say \\impossible\\.","Nothing venture, nothing have.","If you fail, don't forget to learn your lesson.","No pain, no gain","We can only move forward, forward, by any means necessary to move forward.","Your fearlessness comes from ignorance.","Intelligence lies in diligence, and genius in accumulation.","Never be satisfied with learning; never be tired of teaching.","Books are the ladder of human progress.","An inch of time is an inch of gold, but you can't buy time with gold."]}</script>
    <script defer src="/lib/subtitle_typing.js"></script><script>
  window.addEventListener('DOMContentLoaded', () => {
    'use strict';
    
    let time, hidden, visible, title = document.title;
    let favicon = document.querySelector('link[rel="icon"]');
    
      hidden = 'hiding | wbw121124\'s Blog';
      visible = 'welcome back to wbw121124\'s Blog';
    
    let random = t => t[Math.floor(Math.random() * t.length)];
    const change = () => {
      if (document.hidden) {
        favicon.setAttribute('href', '/images/favicon-32x32-next.png');
        
          document.title = hidden;
        
        clearTimeout(time);
      } else {
        favicon.setAttribute('href', '/images/favicon-32x32-next.png');
        
          document.title = visible;
        
        time = setTimeout(() => {
          document.title = title;
        }, 2000);
      }
    }
    document.addEventListener('visibilitychange', change, false);
  });
</script>
<script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="150" mobile="false"
	src="/js/pen.js"></script>
<style>
	.anchorjs-link {
		transition: all .25s linear;
		margin-left: -0.25em !important;
	}

	*:hover>.anchorjs-link {
		margin-left: 0.1875em !important;
	}

	.main-inner,
	header,
	.sidebar-inner,
	.animated {
		border-radius: 5px !important;
	}

	.custom-logo-image {
		height: 50px;
	}
</style>
<!-- <script src="/js/anchor.min.js" onload="anchors.add();"></script> -->
<script type="module">
	import '/js/anchor.min.js';
	function addAnchors() {
		if (window.location.pathname!==''&&window.location.pathname!=='/'&&window.location.pathname!=='/index.html') {
			anchors.add();
		}
	}
	document.addEventListener('DOMContentLoaded', () => {
		addAnchors();
	});
	setInterval(() => {addAnchors(); }, 5000);
</script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">wbw121124's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">wbw121124的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B9%B3%E8%A1%A1%E6%A0%91"><span class="nav-number">1.</span> <span class="nav-text"> 平衡树</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#fhq_treap-%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.1.</span> <span class="nav-text"> Fhq_treap 实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%8B%E9%A2%98"><span class="nav-number">1.1.1.</span> <span class="nav-text"> 例题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B4%9B%E8%B0%B7p1486"><span class="nav-number">1.1.1.1.</span> <span class="nav-text"> 洛谷P1486</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B4%9B%E8%B0%B7p2234"><span class="nav-number">1.1.1.2.</span> <span class="nav-text"> 洛谷P2234</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B4%9B%E8%B0%B7p3224"><span class="nav-number">1.1.1.3.</span> <span class="nav-text"> 洛谷P3224</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B4%9B%E8%B0%B7p6136"><span class="nav-number">1.1.1.4.</span> <span class="nav-text"> 洛谷P6136</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E8%89%BA%E5%B9%B3%E8%A1%A1%E6%A0%91fhq_treap-%E7%89%88"><span class="nav-number">1.2.</span> <span class="nav-text"> 文艺平衡树（fhq_treap 版）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%8B%E9%A2%98-2"><span class="nav-number">1.2.1.</span> <span class="nav-text"> 例题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B4%9B%E8%B0%B7p3391"><span class="nav-number">1.2.1.1.</span> <span class="nav-text"> 洛谷P3391</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B4%9B%E8%B0%B7p3850"><span class="nav-number">1.2.1.2.</span> <span class="nav-text"> 洛谷P3850</span></a></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wbw121124"
      src="https://cdn.luogu.com.cn/upload/usericon/792595.png">
  <p class="site-author-name" itemprop="name">wbw121124</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wbw121124" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wbw121124" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/wbw121124" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;wbw121124" rel="noopener me" target="_blank">CSDN</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wbwblog.github.io/2019/12/31/%E5%B9%B3%E8%A1%A1%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.luogu.com.cn/upload/usericon/792595.png">
      <meta itemprop="name" content="wbw121124">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wbw121124's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="平衡树 | wbw121124's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          平衡树<a href="https://github.com/wbwblog/wbwblog.github.io/edit/main/source/_posts/%E5%B9%B3%E8%A1%A1%E6%A0%91.md" class="post-edit-link" title="编辑" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2020-01-01T00:00:00+08:00">2020-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-25 15:55:18" itemprop="dateModified" datetime="2025-09-25T15:55:18+08:00">2025-09-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">编程</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B9%B3%E8%A1%A1%E6%A0%91/" itemprop="url" rel="index"><span itemprop="name">平衡树</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="平衡树"><a class="markdownIt-Anchor" href="#平衡树"></a> 平衡树</h1>
<p>全称是二叉搜索平衡树</p>
<p>二叉搜索树：对于一棵二叉树，每个节点有权值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">val</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>，任意节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> 的左子树的权值小于等于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><msub><mi>l</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">val_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，右子树反之。</p>
<p>二叉搜索树的优点：</p>
<ol>
<li>具有单调性，可以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">log_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的时间查找。</li>
<li>二叉搜索树的中序遍历是单调不减的，可以将下标当做权值，这样一个序列可以映射到一棵二叉搜索树。</li>
</ol>
<p>为什么需要平衡树？</p>
<ul>
<li>一个序列对应的二叉搜索树不唯一。我们希望找到高度最小的那颗应用。</li>
</ul>
<p>若一棵二叉树的任意一个结点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span>，其左右子树高度差不超过 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，称为二叉平衡树。</p>
<span id="more"></span>
<p>算法竞赛领域常用的平衡树：</p>
<ol>
<li>treap</li>
<li>splay</li>
<li>fhq_treap</li>
</ol>
<p>其中，treap 和 fhq_treap 利用的是随机平衡，不追求绝对平衡。splay 是贪心策略平衡。treap 和 splay 都是通过旋转改变形态，fhq_treap 通过分裂和合并来改变形态。</p>
<h2 id="fhq_treap-实现"><a class="markdownIt-Anchor" href="#fhq_treap-实现"></a> Fhq_treap 实现</h2>
<ol>
<li>
<p>分裂操作</p>
<p>将一棵平衡树分裂成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> 两棵子树，且 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><msub><mi>l</mi><mi>a</mi></msub><mo>≤</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><msub><mi>l</mi><mi>b</mi></msub><mo>&gt;</mo><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">val_a\le val,val_b&gt;val</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">val</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 是选取的某个数。</p>
<pre class="highlight"><code class="cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span> &#123;
	<span class="hljs-type">int</span> val, l, r, size, rnk;
&#125;tree[N];
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> cur)</span>
</span>&#123;
	tree[cur].size = tree[tree[cur].l].size + tree[tree[cur].r].size + <span class="hljs-number">1</span>;
	<span class="hljs-keyword">return</span>;
&#125;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">split</span><span class="hljs-params">(<span class="hljs-type">int</span> cur, <span class="hljs-type">int</span>&amp; a, <span class="hljs-type">int</span>&amp; b, <span class="hljs-type">int</span> val)</span>
</span>&#123;
	<span class="hljs-keyword">if</span> (!cur)
	&#123;
		a = b = <span class="hljs-number">0</span>;
		<span class="hljs-keyword">return</span>;
	&#125;
	<span class="hljs-keyword">if</span> (tree[cur].val &lt;= val)
	&#123;
		a = cur;
		<span class="hljs-built_in">split</span>(tree[cur].r, tree[cur].r, b, val);
	&#125;
	<span class="hljs-keyword">else</span>
	&#123;
		b = cur;
		<span class="hljs-built_in">split</span>(tree[cur].l, a, tree[cur].l, val);
	&#125;
	<span class="hljs-built_in">update</span>(cur);
	<span class="hljs-keyword">return</span>;
&#125;
</code></pre>
</li>
<li>
<p>合并操作</p>
<p>将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo separator="true">,</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a,b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">b</span></span></span></span> 两棵平衡树合并，且 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> 平衡树的任意权值一定小于等于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> 平衡树的任意权值。</p>
</li>
</ol>
<p>模板完整代码：</p>
<pre class="highlight"><code class="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">typedef</span> <span class="hljs-type">int</span> int32;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> N = <span class="hljs-number">1e5</span> + <span class="hljs-number">5</span>;
<span class="hljs-type">int</span> n, root, cnt;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span> &#123;
	<span class="hljs-type">int</span> val, l, r, size, rnk;
&#125;tree[N];
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> cur)</span>
</span>&#123;
	tree[cur].size = tree[tree[cur].l].size + tree[tree[cur].r].size + <span class="hljs-number">1</span>;
	<span class="hljs-keyword">return</span>;
&#125;
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">add_node</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span>
</span>&#123;
	tree[++cnt] = &#123; val,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-built_in">rand</span>() &#125;;
	<span class="hljs-keyword">return</span> cnt;
&#125;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">split</span><span class="hljs-params">(<span class="hljs-type">int</span> cur, <span class="hljs-type">int</span>&amp; a, <span class="hljs-type">int</span>&amp; b, <span class="hljs-type">int</span> val)</span>
</span>&#123;
	<span class="hljs-keyword">if</span> (!cur)
	&#123;
		a = b = <span class="hljs-number">0</span>;
		<span class="hljs-keyword">return</span>;
	&#125;
	<span class="hljs-keyword">if</span> (tree[cur].val &lt;= val)
	&#123;
		a = cur;
		<span class="hljs-built_in">split</span>(tree[cur].r, tree[cur].r, b, val);
	&#125;
	<span class="hljs-keyword">else</span>
	&#123;
		b = cur;
		<span class="hljs-built_in">split</span>(tree[cur].l, a, tree[cur].l, val);
	&#125;
	<span class="hljs-built_in">update</span>(cur);
	<span class="hljs-keyword">return</span>;
&#125;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">merge</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; cur, <span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span><span class="hljs-comment">//合并</span>
</span>&#123;
	<span class="hljs-keyword">if</span> (!a || !b)
	&#123;
		cur = a + b;
		<span class="hljs-keyword">return</span>;
	&#125;
	<span class="hljs-keyword">if</span> (tree[a].rnk &lt;= tree[b].rnk)
	&#123;
		cur = a;
		<span class="hljs-built_in">merge</span>(tree[a].r, tree[a].r, b);
	&#125;
	<span class="hljs-keyword">else</span>
	&#123;
		cur = b;
		<span class="hljs-built_in">merge</span>(tree[b].l, a, tree[b].l);
	&#125;
	<span class="hljs-built_in">update</span>(cur);
	<span class="hljs-keyword">return</span>;
&#125;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; cur, <span class="hljs-type">int</span> val)</span><span class="hljs-comment">//插入</span>
</span>&#123;
	<span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">0</span>, c = <span class="hljs-built_in">add_node</span>(val);
	<span class="hljs-built_in">split</span>(cur, a, b, val);
	<span class="hljs-built_in">merge</span>(a, a, c);
	<span class="hljs-built_in">merge</span>(cur, a, b);
	<span class="hljs-keyword">return</span>;
&#125;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">del</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; cur, <span class="hljs-type">int</span> val)</span><span class="hljs-comment">//输出</span>
</span>&#123;
	<span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">0</span>, c = <span class="hljs-number">0</span>;
	<span class="hljs-built_in">split</span>(cur, a, b, val);
	<span class="hljs-built_in">split</span>(a, a, c, val - <span class="hljs-number">1</span>);
	<span class="hljs-built_in">merge</span>(c, tree[c].l, tree[c].r);
	<span class="hljs-built_in">merge</span>(a, a, c);
	<span class="hljs-built_in">merge</span>(cur, a, b);
	<span class="hljs-keyword">return</span>;
&#125;
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">find_num</span><span class="hljs-params">(<span class="hljs-type">int</span> cur, <span class="hljs-type">int</span> x)</span><span class="hljs-comment">//寻找第 $x$ 个元素</span>
</span>&#123;
	<span class="hljs-keyword">while</span> (tree[tree[cur].l].size + <span class="hljs-number">1</span> != x)
		<span class="hljs-keyword">if</span> (tree[tree[cur].l].size &gt;= x)
			cur = tree[cur].l;
		<span class="hljs-keyword">else</span>
		&#123;
			x -= tree[tree[cur].l].size + <span class="hljs-number">1</span>;
			cur = tree[cur].r;
		&#125;
	<span class="hljs-keyword">return</span> tree[cur].val;
&#125;
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">find_rank</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; cur, <span class="hljs-type">int</span> val)</span><span class="hljs-comment">//寻找 $val$ 的第一个位置</span>
</span>&#123;
	<span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">0</span>;
	<span class="hljs-built_in">split</span>(cur, a, b, val - <span class="hljs-number">1</span>);
	<span class="hljs-type">int</span> tmp = tree[a].size + <span class="hljs-number">1</span>;
	<span class="hljs-built_in">merge</span>(cur, a, b);
	<span class="hljs-keyword">return</span> tmp;
&#125;
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">prev</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; cur, <span class="hljs-type">int</span> val)</span><span class="hljs-comment">//寻找前驱</span>
</span>&#123;
	<span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">0</span>;
	<span class="hljs-built_in">split</span>(cur, a, b, val - <span class="hljs-number">1</span>);
	<span class="hljs-type">int</span> tmp = <span class="hljs-built_in">find_num</span>(a, tree[a].size);
	<span class="hljs-built_in">merge</span>(cur, a, b);
	<span class="hljs-keyword">return</span> tmp;
&#125;
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">suf</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; cur, <span class="hljs-type">int</span> val)</span><span class="hljs-comment">//寻找后继</span>
</span>&#123;
	<span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">0</span>;
	<span class="hljs-built_in">split</span>(cur, a, b, val);
	<span class="hljs-type">int</span> tmp = <span class="hljs-built_in">find_num</span>(b, <span class="hljs-number">1</span>);
	<span class="hljs-built_in">merge</span>(cur, a, b);
	<span class="hljs-keyword">return</span> tmp;
&#125;
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>&#123;
	ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>);
	cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>), cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);
	<span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-number">0</span>));
	cin &gt;&gt; n;
	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++)
	&#123;
		<span class="hljs-type">int</span> opt, val;
		cin &gt;&gt; opt &gt;&gt; val;
		<span class="hljs-keyword">if</span> (opt == <span class="hljs-number">1</span>)
			<span class="hljs-built_in">insert</span>(root, val);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opt == <span class="hljs-number">2</span>)
			<span class="hljs-built_in">del</span>(root, val);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opt == <span class="hljs-number">3</span>)
			cout &lt;&lt; <span class="hljs-built_in">find_rank</span>(root, val) &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opt == <span class="hljs-number">4</span>)
			cout &lt;&lt; <span class="hljs-built_in">find_num</span>(root, val) &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opt == <span class="hljs-number">5</span>)
			cout &lt;&lt; <span class="hljs-built_in">prev</span>(root, val) &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;
		<span class="hljs-keyword">else</span>
			cout &lt;&lt; <span class="hljs-built_in">suf</span>(root, val) &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;
	&#125;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;
</code></pre>
<h3 id="例题"><a class="markdownIt-Anchor" href="#例题"></a> 例题</h3>
<h4 id="洛谷p1486"><a class="markdownIt-Anchor" href="#洛谷p1486"></a> 洛谷P1486</h4>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1486">P1486 郁闷的出纳员</a></p>
<p>NOI2004 的题。</p>
<blockquote>
<p>第一行有两个整数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>min</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66786em;vertical-align:0em;"></span><span class="mop">min</span></span></span></span>。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 表示下面有多少条命令，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>min</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66786em;vertical-align:0em;"></span><span class="mop">min</span></span></span></span> 表示工资下界。</p>
<p>接下来的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 行，每行一个字符 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> 和一个整数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>，表示一条命令。命令可以是以下四种之一：</p>
<ul>
<li><code>I k</code>  新建一个工资档案，初始工资为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>。如果某员工的初始工资低于工资下界，他将立刻离开公司。</li>
<li><code>A k</code>   把每位员工的工资加上 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>。</li>
<li><code>S k</code>   把每位员工的工资扣除 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>。</li>
<li><code>F k</code>    查询第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 多的工资。</li>
</ul>
<p>在初始时，可以认为公司里一个员工也没有。</p>
</blockquote>
<p>维护一个全局懒标记，懒标记减的时候删除离开的人。</p>
<pre class="highlight"><code class="cpp"><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>&#123;
	ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>);
	cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>), cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);
	<span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-number">0</span>));
	cin &gt;&gt; n &gt;&gt; m;
	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++)
	&#123;
		<span class="hljs-type">char</span> c;
		<span class="hljs-type">int</span> x;
		cin &gt;&gt; c &gt;&gt; x;
		<span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;I&#x27;</span>)
			<span class="hljs-keyword">if</span> (x &gt;= m)
				<span class="hljs-built_in">insert</span>(root, x - tag);
			<span class="hljs-keyword">else</span>
				;
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;A&#x27;</span>)
			tag += x;
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;S&#x27;</span>)
		&#123;
			tag -= x;
			<span class="hljs-keyword">while</span> (root &amp;&amp; <span class="hljs-built_in">find_num</span>(root, <span class="hljs-number">1</span>) + tag &lt; m)
				<span class="hljs-built_in">del</span>(root, <span class="hljs-built_in">find_num</span>(root, <span class="hljs-number">1</span>)), sum++;
		&#125;
		<span class="hljs-keyword">else</span>
			<span class="hljs-keyword">if</span> (!root || tree[root].size &lt; x)
				cout &lt;&lt; <span class="hljs-string">&quot;-1\n&quot;</span>;
			<span class="hljs-keyword">else</span>
				cout &lt;&lt; <span class="hljs-built_in">find_num</span>(root, tree[root].size - x + <span class="hljs-number">1</span>) + tag &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;
	&#125;
	cout &lt;&lt; sum;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;
</code></pre>
<h4 id="洛谷p2234"><a class="markdownIt-Anchor" href="#洛谷p2234"></a> 洛谷P2234</h4>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P2234">P2234 营业额统计</a></p>
<blockquote>
<p>而分析整个公司的从成立到现在营业情况是否稳定，只需要把每一天的最小波动值加起来就可以了。你的任务就是编写一个程序帮助 Tiger 来计算这一个值。</p>
<p>我们定义，一天的最小波动值 = <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>min</mi><mo>⁡</mo><mo stretchy="false">{</mo><mi mathvariant="normal">∣</mi><mtext>该天以前某一天的营业额</mtext><mo>−</mo><mtext>该天营业额</mtext><mi mathvariant="normal">∣</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\min\{|\text{该天以前某一天的营业额}-\text{该天营业额}|\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">min</span><span class="mopen">{</span><span class="mord">∣</span><span class="mord text"><span class="mord cjk_fallback">该天以前某一天的营业额</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord cjk_fallback">该天营业额</span></span><span class="mord">∣</span><span class="mclose">}</span></span></span></span>。</p>
<p>特别地，第一天的最小波动值为第一天的营业额。</p>
</blockquote>
<p>和前驱后继减，即可保证最小。</p>
<pre class="highlight"><code class="cpp"><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>&#123;
	ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>);
	cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>), cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);
	<span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-number">0</span>));
	cin &gt;&gt; n;
	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++)
	&#123;
		<span class="hljs-type">int</span> x;
		cin &gt;&gt; x;
		<span class="hljs-built_in">insert</span>(root, x);
		<span class="hljs-keyword">if</span> (i == <span class="hljs-number">1</span>)
			sum += x;
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tree[root].size == <span class="hljs-built_in">find_rank</span>(root, x))
			sum += <span class="hljs-built_in">abs</span>(<span class="hljs-built_in">prev</span>(root, x) - x);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">find_rank</span>(root, x) == <span class="hljs-number">1</span>)
			sum += <span class="hljs-built_in">abs</span>(<span class="hljs-built_in">suf</span>(root, x) - x);
		<span class="hljs-keyword">else</span>
			sum += <span class="hljs-built_in">min</span>(<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">prev</span>(root, x) - x), <span class="hljs-built_in">abs</span>(<span class="hljs-built_in">suf</span>(root, x) - x));
	&#125;
	cout &lt;&lt; sum;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;
</code></pre>
<h4 id="洛谷p3224"><a class="markdownIt-Anchor" href="#洛谷p3224"></a> 洛谷P3224</h4>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P3224">P3224 永无乡</a></p>
<blockquote>
<p>永无乡包含 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 座岛，编号从 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> ，每座岛都有自己的独一无二的重要度，按照重要度可以将这 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 座岛排名，名次用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>  到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 来表示。某些岛之间由巨大的桥连接，通过桥可以从一个岛到达另一个岛。如果从岛 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> 出发经过若干座（含 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 座）桥可以 到达岛 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> ，则称岛 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> 和岛 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> 是连通的。</p>
<p>现在有两种操作：</p>
<p><code>B x y</code> 表示在岛 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> 与岛 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> 之间修建一座新桥。</p>
<p><code>Q x k</code> 表示询问当前与岛 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> 连通的所有岛中第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 重要的是哪座岛，即所有与岛 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> 连通的岛中重要度排名第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 小的岛是哪座，请你输出那个岛的编号。</p>
</blockquote>
<p>使用并查集+平衡树，合并使用启发式合并，即拆小的往大的上 merge。</p>
<pre class="highlight"><code class="cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">find</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span>
</span>&#123;
	<span class="hljs-keyword">if</span> (x == fa[x])
		<span class="hljs-keyword">return</span> x;
	<span class="hljs-keyword">return</span> fa[x] = <span class="hljs-built_in">find</span>(fa[x]);
&#125;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span>&amp; y)</span>
</span>&#123;
	<span class="hljs-keyword">if</span> (!x)
		<span class="hljs-keyword">return</span>;
	<span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">0</span>, c = x, val = tree[x].val;
	<span class="hljs-type">int</span> l = tree[x].l, r = tree[x].r;
	tree[x].l = tree[x].r = <span class="hljs-number">0</span>;
	<span class="hljs-built_in">split</span>(y, a, b, val);
	<span class="hljs-built_in">merge</span>(a, a, c);
	<span class="hljs-built_in">merge</span>(y, a, b);
	<span class="hljs-built_in">dfs</span>(l, y);
	<span class="hljs-built_in">dfs</span>(r, y);
	<span class="hljs-keyword">return</span>;
&#125;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unionn</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>
</span>&#123;
	x = <span class="hljs-built_in">find</span>(x);
	y = <span class="hljs-built_in">find</span>(y);
	<span class="hljs-keyword">if</span> (x != y)
		<span class="hljs-keyword">if</span> (tree[root[x]].size &lt;= tree[root[y]].size)
		&#123;
			fa[x] = y;
			<span class="hljs-built_in">dfs</span>(root[x], root[y]);
		&#125;
		<span class="hljs-keyword">else</span>
		&#123;
			<span class="hljs-built_in">swap</span>(x, y);
			fa[x] = y;
			<span class="hljs-built_in">dfs</span>(root[x], root[y]);
		&#125;
	<span class="hljs-keyword">return</span>;
&#125;
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>&#123;
	ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>);
	cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>), cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);
	<span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-number">0</span>));
	cin &gt;&gt; n &gt;&gt; m;
	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++)
		cin &gt;&gt; a[i], b[a[i]] = i, fa[i] = i, root[i] = i,
		tree[i] = &#123; a[i],<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-built_in">rand</span>() &#125;;
	cnt = n;
	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= m; i++)
	&#123;
		<span class="hljs-type">int</span> x, y;
		cin &gt;&gt; x &gt;&gt; y;
		<span class="hljs-built_in">unionn</span>(x, y);
	&#125;
	cin &gt;&gt; q;
	<span class="hljs-keyword">while</span> (q--)
	&#123;
		<span class="hljs-type">char</span> c;
		<span class="hljs-type">int</span> x, y;
		cin &gt;&gt; c &gt;&gt; x &gt;&gt; y;
		<span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;B&#x27;</span>)
			<span class="hljs-built_in">unionn</span>(x, y);
		<span class="hljs-keyword">else</span>
			<span class="hljs-keyword">if</span> (tree[root[<span class="hljs-built_in">find</span>(x)]].size &lt; y)
				cout &lt;&lt; <span class="hljs-string">&quot;-1\n&quot;</span>;
			<span class="hljs-keyword">else</span>
				cout &lt;&lt; b[<span class="hljs-built_in">find_num</span>(root[<span class="hljs-built_in">find</span>(x)], y)] &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;
	&#125;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;
</code></pre>
<h4 id="洛谷p6136"><a class="markdownIt-Anchor" href="#洛谷p6136"></a> 洛谷P6136</h4>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P6136">P6136 【模板】普通平衡树（数据加强版）</a></p>
<pre class="highlight"><code class="cpp"><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>&#123;
	ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>);
	cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>), cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);
	<span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-number">0</span>));
	cin &gt;&gt; n &gt;&gt; m;
	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++)
	&#123;
		<span class="hljs-type">int</span> x;
		cin &gt;&gt; x;
		<span class="hljs-built_in">insert</span>(root, x);
	&#125;
	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= m; i++)
	&#123;
		<span class="hljs-type">int</span> opt, val;
		cin &gt;&gt; opt &gt;&gt; val;
		val ^= last;
		<span class="hljs-keyword">if</span>(opt == <span class="hljs-number">1</span>)
			<span class="hljs-built_in">insert</span>(root, val);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(opt == <span class="hljs-number">2</span>)
			<span class="hljs-built_in">del</span>(root, val);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(opt == <span class="hljs-number">3</span>)
			ans ^= (last = <span class="hljs-built_in">find_rank</span>(root, val));
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(opt == <span class="hljs-number">4</span>)
			ans ^= (last = <span class="hljs-built_in">find_num</span>(root, val));
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(opt == <span class="hljs-number">5</span>)
			ans ^= (last = <span class="hljs-built_in">prev</span>(root, val));
		<span class="hljs-keyword">else</span>
			ans ^= (last = <span class="hljs-built_in">suf</span>(root, val));
	&#125;
	cout &lt;&lt; ans;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;
</code></pre>
<h2 id="文艺平衡树fhq_treap-版"><a class="markdownIt-Anchor" href="#文艺平衡树fhq_treap-版"></a> 文艺平衡树（fhq_treap 版）</h2>
<p>需要区间反转时，为了实现区间翻转，我们使用懒标记（lazy tag），像线段树一样。</p>
<ul>
<li>
<p>pushdown 函数</p>
<pre class="highlight"><code class="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> cur)</span>
</span>&#123;
	<span class="hljs-keyword">if</span> (!tree[cur].tag)
		<span class="hljs-keyword">return</span>;
	<span class="hljs-built_in">swap</span>(tree[cur].l, tree[cur].r);
	tree[tree[cur].l].tag ^= <span class="hljs-number">1</span>;
	tree[tree[cur].r].tag ^= <span class="hljs-number">1</span>;
	tree[cur].tag = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">return</span>;
&#125;
</code></pre>
</li>
<li>
<p>split 函数</p>
<pre class="highlight"><code class="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">split</span><span class="hljs-params">(<span class="hljs-type">int</span> cur, <span class="hljs-type">int</span>&amp; a, <span class="hljs-type">int</span>&amp; b, <span class="hljs-type">int</span> val)</span>
</span>&#123;
	<span class="hljs-keyword">if</span> (!cur)
	&#123;
		a = b = <span class="hljs-number">0</span>;
		<span class="hljs-keyword">return</span>;
	&#125;
	<span class="hljs-built_in">pushdown</span>(cur);
	<span class="hljs-keyword">if</span> (tree[tree[cur].l].size + <span class="hljs-number">1</span> &lt;= val)<span class="hljs-comment">//文艺平衡树是按size分的</span>
	&#123;
		a = cur;
		<span class="hljs-built_in">split</span>(tree[cur].r, tree[cur].r, b, val - tree[tree[cur].l].size - <span class="hljs-number">1</span>);
	&#125;
	<span class="hljs-keyword">else</span>
	&#123;
		b = cur;
		<span class="hljs-built_in">split</span>(tree[cur].l, a, tree[cur].l, val);
	&#125;
	<span class="hljs-built_in">update</span>(cur);
	<span class="hljs-keyword">return</span>;
&#125;
</code></pre>
</li>
<li>
<p>merge 函数</p>
<pre class="highlight"><code class="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">merge</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; cur, <span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>
</span>&#123;
	<span class="hljs-keyword">if</span> (!a || !b)
	&#123;
		cur = a + b;
		<span class="hljs-keyword">return</span>;
	&#125;
	<span class="hljs-keyword">if</span> (tree[a].rnk &lt;= tree[b].rnk)
	&#123;
		<span class="hljs-built_in">pushdown</span>(a);
		cur = a;
		<span class="hljs-built_in">merge</span>(tree[a].r, tree[a].r, b);
	&#125;
	<span class="hljs-keyword">else</span>
	&#123;
		<span class="hljs-built_in">pushdown</span>(b);
		cur = b;
		<span class="hljs-built_in">merge</span>(tree[b].l, a, tree[b].l);
	&#125;
	<span class="hljs-built_in">update</span>(cur);<span class="hljs-comment">//记得update，forget to update 3 times</span>
	<span class="hljs-keyword">return</span>;
&#125;
</code></pre>
</li>
<li>
<p>reverse 函数</p>
<pre class="highlight"><code class="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">reverse</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; cur, <span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>
</span>&#123;
	<span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">0</span>, c = <span class="hljs-number">0</span>;
	<span class="hljs-built_in">split</span>(cur, a, b, y);
	<span class="hljs-built_in">split</span>(a, a, c, x - <span class="hljs-number">1</span>);
	tree[c].tag ^= <span class="hljs-number">1</span>;
	<span class="hljs-built_in">merge</span>(a, a, c);
	<span class="hljs-built_in">merge</span>(cur, a, b);
	<span class="hljs-keyword">return</span>;
&#125;
</code></pre>
</li>
<li>
<p>print 函数</p>
<pre class="highlight"><code class="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span>
</span>&#123;
	<span class="hljs-keyword">if</span> (!x)
		<span class="hljs-keyword">return</span>;
	<span class="hljs-built_in">pushdown</span>(x);
	<span class="hljs-built_in">print</span>(tree[x].l);
	cout &lt;&lt; tree[x].val &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span>;
	<span class="hljs-built_in">print</span>(tree[x].r);
	<span class="hljs-keyword">return</span>;
&#125;
</code></pre>
</li>
</ul>
<h3 id="例题-2"><a class="markdownIt-Anchor" href="#例题-2"></a> 例题</h3>
<h4 id="洛谷p3391"><a class="markdownIt-Anchor" href="#洛谷p3391"></a> 洛谷P3391</h4>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P3391">P3391 【模板】文艺平衡树 - 洛谷</a></p>
<h4 id="洛谷p3850"><a class="markdownIt-Anchor" href="#洛谷p3850"></a> 洛谷P3850</h4>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P3850">P3850 书架</a></p>
<blockquote>
<p>Knuth 先生家里有个精致的书架，书架上有 <em>N</em> 本书，如今他想学到更多的知识，于是又买来了 <em>M</em> 本不同的新书。现在他要把新买的书依次插入到书架中，他已经把每本书要插入的位置标记好了，并且相应的将它们放好。由于 Knuth 年龄已大，过几天他已经记不清某些位置上放的到底是什么书了，请问你能帮助他吗？</p>
</blockquote>
<p>文艺平衡树加一个 <code>string</code> 就可以了</p>
<pre class="highlight"><code class="cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span> &#123;
	<span class="hljs-type">int</span> val, l, r, size, rnk, tag;
	string s;
&#125;tree[N];
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>&#123;
	ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>);
	cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>), cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);
	<span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-number">0</span>));
	cin &gt;&gt; n;
	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++)
	&#123;
		cin &gt;&gt; s;
		<span class="hljs-type">int</span> a = <span class="hljs-built_in">add_node</span>(i);
		tree[a].s = s;
		<span class="hljs-built_in">merge</span>(root, root, a);
	&#125;
	cin &gt;&gt; m;
	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= m; i++)
	&#123;
		<span class="hljs-type">int</span> x;
		cin &gt;&gt; s &gt;&gt; x;
		<span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">0</span>, c = <span class="hljs-built_in">add_node</span>(x);
		tree[c].s = s;
		<span class="hljs-built_in">split</span>(root, a, b, x);
		<span class="hljs-built_in">merge</span>(a, a, c);
		<span class="hljs-built_in">merge</span>(root, a, b);
	&#125;
	cin &gt;&gt; m;
	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= m; i++)
	&#123;
		<span class="hljs-type">int</span> x;
		cin &gt;&gt; x;
		<span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">0</span>, c = <span class="hljs-number">0</span>;
		<span class="hljs-built_in">split</span>(root, a, b, x + <span class="hljs-number">1</span>);
		<span class="hljs-built_in">split</span>(a, a, c, x);
		cout &lt;&lt; tree[c].s &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;
		<span class="hljs-built_in">merge</span>(a, a, c);
		<span class="hljs-built_in">merge</span>(root, a, b);
	&#125;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;
</code></pre>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>wbw121124
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://wbwblog.github.io/2019/12/31/%E5%B9%B3%E8%A1%A1%E6%A0%91/" title="平衡树">https://wbwblog.github.io/2019/12/31/平衡树/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://github.com/wbw121124">
            <span class="icon">
              <i class="fab fa-github"></i>
            </span>

            <span class="label">github</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/%E5%B9%B3%E8%A1%A1%E6%A0%91/" rel="tag"># 平衡树</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/12/31/%E8%BF%9E%E9%80%9A%E6%80%A7%E9%97%AE%E9%A2%98/" rel="prev" title="连通性问题">
                  <i class="fa fa-angle-left"></i> 连通性问题
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wbw121124</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">15k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">56 分钟</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><div style="font-size: 0.85rem">
	<span id="timeDate">load</span>
	<span id="times">ing...</span>
	<script>
		!(function () {
			/** 计时起始时间，自行修改 **/
			var start = new Date("2025/05/01 00:00:00");

			function update() {
				var now = new Date();
				now.setTime(now.getTime() + 250);
				days = (now - start) / 1000 / 60 / 60 / 24;
				dnum = Math.floor(days);
				hours = (now - start) / 1000 / 60 / 60 - (24 * dnum);
				hnum = Math.floor(hours);
				if (String(hnum).length === 1) {
					hnum = "0" + hnum;
				}
				minutes = (now - start) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
				mnum = Math.floor(minutes);
				if (String(mnum).length === 1) {
					mnum = "0" + mnum;
				}
				seconds = (now - start) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
				snum = Math.round(seconds);
				if (String(snum).length === 1) {
					snum = "0" + snum;
				}
				document.getElementById("timeDate").innerHTML = "本站安全运行&nbsp" + dnum + "&nbsp天";
				document.getElementById("times").innerHTML = hnum + "&nbsp小时&nbsp" + mnum + "&nbsp分&nbsp" + snum + "&nbsp秒";
			}

			update();
			setInterval(update, 1000);
		})();
	</script>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"wbwblog/wbwblog.github.io","issue_term":"pathname","theme":"github-dark"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
